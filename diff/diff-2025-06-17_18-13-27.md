# 代码审查总结

## 本次更改概述
本次更改主要实现了邮箱注册功能，包括前端UI组件、后端API路由、数据库架构更新和邮件服务集成。

## 🔴 严重问题
1. **调试日志包含敏感信息**: 在 `app/api/email-register/route.ts` 中添加了大量调试日志，包含用户邮箱、密码长度等敏感信息，生产环境需要移除
2. **密码明文日志**: 调试日志中可能暴露密码相关信息，存在安全风险

## 🟡 重要改进
1. **数据库连接优化**: 改进了数据库连接管理和重试机制，提高了稳定性
2. **错误处理统一**: 统一了API响应格式和错误处理机制
3. **邮件服务集成**: 完整实现了SMTP邮件服务，支持验证码和欢迎邮件发送

## 🟢 优化建议
1. **移除调试日志**: 生产部署前需要清理所有调试相关的console.log和敏感信息日志
2. **环境变量验证**: 建议添加环境变量完整性检查
3. **邮件模板优化**: 可以考虑将邮件模板外部化管理

## ✅ 优秀实践
1. **类型安全**: 使用了TypeScript类型定义，提高了代码安全性
2. **数据库索引**: 为关键字段添加了数据库索引，优化查询性能
3. **参数验证**: 实现了完整的输入参数验证和格式检查
4. **错误重试机制**: 实现了数据库操作的重试机制，提高了系统稳定性

## 提交建议
建议分两次提交：
1. 第一次：移除所有调试日志后提交核心功能
2. 第二次：如需要调试信息，单独提交调试相关代码

---

diff --git a/.env.example b/.env.example
index fcad562..b6d665d 100644
--- a/.env.example
+++ b/.env.example
@@ -1,8 +1,8 @@
 # -----------------------------------------------------------------------------
 # Web Information
 # -----------------------------------------------------------------------------
-NEXT_PUBLIC_WEB_URL = "http://localhost:3000"
-NEXT_PUBLIC_PROJECT_NAME = "ShipAny"
+NEXT_PUBLIC_WEB_URL = "http://localhost:3001"
+NEXT_PUBLIC_PROJECT_NAME = "Your Project Name"
 
 # -----------------------------------------------------------------------------
 # Database with Supabase
@@ -55,23 +55,59 @@ STRIPE_PUBLIC_KEY = ""
 STRIPE_PRIVATE_KEY = ""
 STRIPE_WEBHOOK_SECRET = ""
 
-NEXT_PUBLIC_PAY_SUCCESS_URL = "http://localhost:3000/my-orders"
-NEXT_PUBLIC_PAY_FAIL_URL = "http://localhost:3000/#pricing"
-NEXT_PUBLIC_PAY_CANCEL_URL = "http://localhost:3000/#pricing"
+NEXT_PUBLIC_PAY_SUCCESS_URL = "http://localhost:3001/my-orders"
+NEXT_PUBLIC_PAY_FAIL_URL = "http://localhost:3001/#pricing"
+NEXT_PUBLIC_PAY_CANCEL_URL = "http://localhost:3001/#pricing"
 
 NEXT_PUBLIC_LOCALE_DETECTION = "false"
 
-ADMIN_EMAILS = ""
+# -----------------------------------------------------------------------------
+# Admin Configuration
+# -----------------------------------------------------------------------------
+# Comma-separated list of admin email addresses
+ADMIN_EMAILS = "admin@example.com"
 
+# -----------------------------------------------------------------------------
+# Theme Configuration
+# -----------------------------------------------------------------------------
 NEXT_PUBLIC_DEFAULT_THEME = "light"
 
 # -----------------------------------------------------------------------------
-# Storage with aws s3 sdk
+# Development Configuration
+# -----------------------------------------------------------------------------
+NEXT_PUBLIC_DEV_AUTH_ENABLED = "true"
+
+# NextAuth URL配置
+NEXTAUTH_URL = "http://localhost:3001"
+
+# -----------------------------------------------------------------------------
+# Storage with AWS S3 / Tencent Cloud COS (Optional)
 # https://docs.aws.amazon.com/s3/index.html
+# Get from 腾讯云控制台 → 访问管理 → API密钥管理
 # -----------------------------------------------------------------------------
 STORAGE_ENDPOINT = ""
 STORAGE_REGION = ""
 STORAGE_ACCESS_KEY = ""
 STORAGE_SECRET_KEY = ""
 STORAGE_BUCKET = ""
-STORAGE_DOMAIN = ""
\ No newline at end of file
+STORAGE_DOMAIN = ""
+
+# -----------------------------------------------------------------------------
+# Email Service Configuration (邮件服务配置)
+# -----------------------------------------------------------------------------
+WEWORK_SENDER_EMAIL = "noreply@yourdomain.com"
+WEWORK_SENDER_NAME = "Your Project Name"
+
+# -----------------------------------------------------------------------------
+# SMTP Email Service (SMTP邮件服务) - Recommended
+# Get from your email service provider
+# 腾讯企业邮箱: smtp.exmail.qq.com:465
+# Gmail: smtp.gmail.com:587
+# QQ邮箱: smtp.qq.com:587
+# 163邮箱: smtp.163.com:465
+# -----------------------------------------------------------------------------
+SMTP_HOST = "smtp.exmail.qq.com"
+SMTP_PORT = "465"
+SMTP_SECURE = "true"
+SMTP_USER = "noreply@yourdomain.com"
+SMTP_PASS = ""
\ No newline at end of file
diff --git a/app/[locale]/(admin)/layout.tsx b/app/[locale]/(admin)/layout.tsx
index f94e2a9..ec6c9aa 100644
--- a/app/[locale]/(admin)/layout.tsx
+++ b/app/[locale]/(admin)/layout.tsx
@@ -57,6 +57,11 @@ export default async function AdminLayout({
           url: "/admin/feedbacks",
           icon: "RiMessage2Line",
         },
+        {
+          title: "邮件服务管理",
+          url: "/admin/email",
+          icon: "RiMailLine",
+        },
       ],
     },
     social: {
diff --git a/app/api/get-user-info/route.ts b/app/api/get-user-info/route.ts
index de579ab..83273d0 100644
--- a/app/api/get-user-info/route.ts
+++ b/app/api/get-user-info/route.ts
@@ -3,24 +3,60 @@ import { respData, respErr, respJson } from "@/lib/resp";
 import { findUserByUuid } from "@/models/user";
 import { getUserUuid } from "@/services/user";
 import { getUserCredits } from "@/services/credit";
+import { checkDatabaseHealth } from "@/models/db";
 
 export async function POST(req: Request) {
+  const startTime = Date.now();
+  let user_uuid = "";
+
   try {
-    const user_uuid = await getUserUuid();
+    console.log("[get-user-info] 开始获取用户信息");
+
+    // 获取用户UUID
+    user_uuid = await getUserUuid();
+    console.log("[get-user-info] 获取用户UUID:", user_uuid ? "成功" : "失败");
+
     if (!user_uuid) {
+      console.log("[get-user-info] 用户未认证");
       return respJson(-2, "no auth");
     }
 
+    // 查询用户信息
+    console.log("[get-user-info] 开始查询用户信息, UUID:", user_uuid);
     const user = await findUserByUuid(user_uuid);
+    console.log("[get-user-info] 用户信息查询结果:", user ? "找到用户" : "用户不存在");
+
     if (!user) {
+      console.log("[get-user-info] 用户不存在, UUID:", user_uuid);
       return respErr("user not exist");
     }
 
-    user.credits = await getUserCredits(user_uuid);
+    // 获取用户积分
+    console.log("[get-user-info] 开始获取用户积分");
+    const userCredits = await getUserCredits(user_uuid);
+    console.log("[get-user-info] 积分获取结果:", userCredits);
+
+    user.credits = userCredits;
+
+    const duration = Date.now() - startTime;
+    console.log(`[get-user-info] 成功获取用户信息, 耗时: ${duration}ms`);
 
     return respData(user);
   } catch (e) {
-    console.log("get user info failed: ", e);
+    const duration = Date.now() - startTime;
+    console.error(`[get-user-info] 获取用户信息失败, 耗时: ${duration}ms, UUID: ${user_uuid}, 错误:`, e);
+
+    // 记录详细错误信息
+    if (e instanceof Error) {
+      console.error("[get-user-info] 错误详情:", {
+        name: e.name,
+        message: e.message,
+        stack: e.stack,
+        user_uuid,
+        duration
+      });
+    }
+
     return respErr("get user info failed");
   }
 }
diff --git a/app/api/ping/route.ts b/app/api/ping/route.ts
index 2aa71b7..d8b9345 100644
--- a/app/api/ping/route.ts
+++ b/app/api/ping/route.ts
@@ -3,20 +3,37 @@ import {
   CreditsTransType,
   decreaseCredits,
 } from "@/services/credit";
-import { respData, respErr } from "@/lib/resp";
+import { respData, respInvalidParams, respUnauthorized, respErr, ErrorCode } from "@/lib/resp";
 
 import { getUserUuid } from "@/services/user";
 
+// 定义请求体类型
+interface PingRequest {
+  message: string;
+}
+
+// 定义响应体类型
+interface PongResponse {
+  pong: string;
+}
+
 export async function POST(req: Request) {
   try {
-    const { message } = await req.json();
-    if (!message) {
-      return respErr("invalid params");
+    const body: PingRequest = await req.json();
+
+    // 验证参数
+    if (!body.message || typeof body.message !== 'string') {
+      return respInvalidParams("消息内容不能为空");
+    }
+
+    // 验证消息长度
+    if (body.message.length > 1000) {
+      return respInvalidParams("消息内容过长，最多1000字符");
     }
 
     const user_uuid = await getUserUuid();
     if (!user_uuid) {
-      return respErr("no auth");
+      return respUnauthorized("用户未登录");
     }
 
     // decrease credits for ping
@@ -26,11 +43,13 @@ export async function POST(req: Request) {
       credits: CreditsAmount.PingCost,
     });
 
-    return respData({
-      pong: `received message: ${message}`,
-    });
+    const response: PongResponse = {
+      pong: `received message: ${body.message}`,
+    };
+
+    return respData(response);
   } catch (e) {
-    console.log("test failed:", e);
-    return respErr("test failed");
+    console.error("ping test failed:", e);
+    return respErr("测试失败，请稍后再试", ErrorCode.INTERNAL_ERROR);
   }
 }
diff --git a/app/api/update-invite-code/route.ts b/app/api/update-invite-code/route.ts
index 6d73777..8faa3c1 100644
--- a/app/api/update-invite-code/route.ts
+++ b/app/api/update-invite-code/route.ts
@@ -3,51 +3,63 @@ import {
   findUserByUuid,
   updateUserInviteCode,
 } from "@/models/user";
-import { respData, respErr } from "@/lib/resp";
+import { respData, respInvalidParams, respUnauthorized, respErr, ErrorCode } from "@/lib/resp";
 
 import { getUserUuid } from "@/services/user";
 
 export async function POST(req: Request) {
   try {
     const { invite_code } = await req.json();
-    if (!invite_code) {
-      return respErr("invalid params");
-    }
 
-    if (invite_code.length < 2 || invite_code.length > 16) {
-      return respErr("invalid invite code, length must be between 2 and 16");
+    // 邀请码可以为空，表示不设置邀请码
+    if (invite_code !== undefined && invite_code !== null && invite_code !== '') {
+      // 验证邀请码格式
+      if (typeof invite_code !== 'string' || invite_code.length < 2 || invite_code.length > 16) {
+        return respInvalidParams("邀请码长度必须在2-16字符之间");
+      }
+
+      // 验证邀请码只包含字母数字
+      if (!/^[a-zA-Z0-9]+$/.test(invite_code)) {
+        return respInvalidParams("邀请码只能包含字母和数字");
+      }
     }
 
     const user_uuid = await getUserUuid();
     if (!user_uuid) {
-      return respErr("no auth");
+      return respUnauthorized("用户未登录");
     }
 
     const user_info = await findUserByUuid(user_uuid);
     if (!user_info || !user_info.email) {
-      return respErr("invalid user");
+      return respUnauthorized("用户信息无效");
     }
 
+    // 如果邀请码没有变化，直接返回
     if (user_info.invite_code === invite_code) {
       return respData(user_info);
     }
 
-    const user_by_invite_code = await findUserByInviteCode(invite_code);
-    if (user_by_invite_code) {
-      if (user_by_invite_code.uuid !== user_uuid) {
-        return respErr("invite code already exists");
-      }
+    // 如果设置了邀请码，检查是否已被使用
+    if (invite_code && invite_code.trim() !== '') {
+      const user_by_invite_code = await findUserByInviteCode(invite_code);
+      if (user_by_invite_code) {
+        if (user_by_invite_code.uuid !== user_uuid) {
+          return respInvalidParams("邀请码已被使用，请选择其他邀请码");
+        }
 
-      return respData(user_by_invite_code);
+        return respData(user_by_invite_code);
+      }
     }
 
-    await updateUserInviteCode(user_uuid, invite_code);
+    // 更新邀请码（可以为空字符串，表示清除邀请码）
+    const finalInviteCode = invite_code && invite_code.trim() !== '' ? invite_code.trim() : '';
+    await updateUserInviteCode(user_uuid, finalInviteCode);
 
-    user_info.invite_code = invite_code;
+    user_info.invite_code = finalInviteCode;
 
     return respData(user_info);
   } catch (e) {
-    console.log("update invite code failed", e);
-    return respErr("update invite code failed");
+    console.error("update invite code failed", e);
+    return respErr("更新邀请码失败，请稍后再试", ErrorCode.DATABASE_ERROR);
   }
 }
diff --git a/auth/config.ts b/auth/config.ts
index cfe2725..074e018 100644
--- a/auth/config.ts
+++ b/auth/config.ts
@@ -8,9 +8,76 @@ import { getClientIp } from "@/lib/ip";
 import { getIsoTimestr } from "@/lib/time";
 import { getUuid } from "@/lib/hash";
 import { saveUser } from "@/services/user";
+import { findEmailUser } from "@/models/user";
+import { log } from "@/lib/logger";
+import bcrypt from "bcrypt";
 
 let providers: Provider[] = [];
 
+// Email/Password Auth
+providers.push(
+  CredentialsProvider({
+    id: "email",
+    name: "Email",
+    credentials: {
+      email: { label: "Email", type: "email" },
+      password: { label: "Password", type: "password" },
+    },
+    async authorize(credentials) {
+      const email = credentials?.email as string;
+      log.info("邮箱登录验证开始", { email });
+
+      if (!credentials?.email || !credentials?.password) {
+        log.security("邮箱登录失败: 缺少邮箱或密码", { email });
+        return null;
+      }
+
+      try {
+        // 查找用户
+        const user = await findEmailUser(email);
+
+        if (!user) {
+          log.security("邮箱登录失败: 用户不存在", { email });
+          return null;
+        }
+
+        // 验证密码
+        if (!user.password_hash) {
+          log.security("邮箱登录失败: 用户未设置密码", { email, userId: user.uuid });
+          return null;
+        }
+
+        const isPasswordValid = await bcrypt.compare(
+          credentials.password as string,
+          user.password_hash
+        );
+
+        if (!isPasswordValid) {
+          log.security("邮箱登录失败: 密码错误", { email, userId: user.uuid });
+          return null;
+        }
+
+        // 检查邮箱是否已验证
+        if (!user.email_verified) {
+          log.security("邮箱登录失败: 邮箱未验证", { email, userId: user.uuid });
+          return null;
+        }
+
+        log.audit("邮箱登录成功", { email, userId: user.uuid });
+        return {
+          id: user.uuid || '',
+          email: user.email,
+          name: user.nickname,
+          image: user.avatar_url,
+        };
+      } catch (error) {
+        log.error("邮箱登录异常", error as Error, { email });
+        return null;
+      }
+    },
+  })
+);
+
 // Google One Tap Auth
 if (
   process.env.NEXT_PUBLIC_AUTH_GOOGLE_ONE_TAP_ENABLED === "true" &&
@@ -25,10 +92,10 @@ if (
         credential: { type: "text" },
       },
 
-      async authorize(credentials, req) {
+      async authorize(credentials) {
         const googleClientId = process.env.NEXT_PUBLIC_AUTH_GOOGLE_ID;
         if (!googleClientId) {
-          console.log("invalid google auth config");
+          log.error("Google One Tap 认证配置无效", undefined, { provider: 'google-one-tap' });
           return null;
         }
 
@@ -38,13 +105,13 @@ if (
           "https://oauth2.googleapis.com/tokeninfo?id_token=" + token
         );
         if (!response.ok) {
-          console.log("Failed to verify token");
+          log.error("Google One Tap token 验证失败", undefined, { provider: 'google-one-tap' });
           return null;
         }
 
         const payload = await response.json();
         if (!payload) {
-          console.log("invalid payload from token");
+          log.error("Google One Tap token payload 无效", undefined, { provider: 'google-one-tap' });
           return null;
         }
 
@@ -57,7 +124,7 @@ if (
           picture: image,
         } = payload;
         if (!email) {
-          console.log("invalid email in payload");
+          log.error("Google One Tap payload 中缺少邮箱信息", undefined, { provider: 'google-one-tap' });
           return null;
         }
 
@@ -120,15 +187,48 @@ export const authOptions: NextAuthConfig = {
     signIn: "/auth/signin",
   },
   callbacks: {
-    async signIn({ user, account, profile, email, credentials }) {
-      const isAllowedToSignIn = true;
-      if (isAllowedToSignIn) {
+    async signIn({ user, account }) {
+      try {
+        // 基本验证：必须有邮箱
+        if (!user.email) {
+          log.security("登录失败: 缺少邮箱信息", { provider: account?.provider });
+          return false;
+        }
+
+        // 检查管理员黑名单（如果配置了）
+        const blockedEmails = (process.env.BLOCKED_EMAILS || '').split(',').map(email => email.trim()).filter(Boolean);
+        if (blockedEmails.includes(user.email)) {
+          log.security("登录失败: 邮箱在黑名单中", { email: user.email, provider: account?.provider });
+          return false;
+        }
+
+        // 对于邮箱登录，确保邮箱已验证
+        if (account?.provider === 'email') {
+          const emailUser = await findEmailUser(user.email);
+          if (!emailUser) {
+            log.security("邮箱登录失败: 用户不存在", { email: user.email });
+            return false;
+          }
+          if (!emailUser.email_verified) {
+            log.security("邮箱登录失败: 邮箱未验证", { email: user.email, userId: emailUser.uuid });
+            return false;
+          }
+        }
+
+        // 对于OAuth登录，检查邮箱验证状态
+        if (account?.provider === 'google' || account?.provider === 'github') {
+          // OAuth提供商通常已验证邮箱，但我们仍然检查
+          if (!user.email) {
+            log.security("OAuth登录失败: 缺少邮箱信息", { provider: account?.provider });
+            return false;
+          }
+        }
+
+        log.audit("用户登录成功", { email: user.email, provider: account?.provider });
         return true;
-      } else {
-        // Return false to display a default error message
+      } catch (error) {
+        log.error("登录验证异常", error as Error, { email: user.email, provider: account?.provider });
         return false;
-        // Or you can return a URL to redirect to:
-        // return '/unauthorized'
       }
     },
     async redirect({ url, baseUrl }) {
@@ -138,7 +238,7 @@ export const authOptions: NextAuthConfig = {
       else if (new URL(url).origin === baseUrl) return url;
       return baseUrl;
     },
-    async session({ session, token, user }) {
+    async session({ session, token }) {
       if (token && token.user && token.user) {
         session.user = token.user;
       }
@@ -147,36 +247,52 @@ export const authOptions: NextAuthConfig = {
     async jwt({ token, user, account }) {
       // Persist the OAuth access_token and or the user id to the token right after signin
       try {
-        if (user && user.email && account) {
-          const dbUser: User = {
-            uuid: getUuid(),
-            email: user.email,
-            nickname: user.name || "",
-            avatar_url: user.image || "",
-            signin_type: account.type,
-            signin_provider: account.provider,
-            signin_openid: account.providerAccountId,
-            created_at: getIsoTimestr(),
-            signin_ip: await getClientIp(),
-          };
-
-          try {
-            const savedUser = await saveUser(dbUser);
-
-            token.user = {
-              uuid: savedUser.uuid,
-              email: savedUser.email,
-              nickname: savedUser.nickname,
-              avatar_url: savedUser.avatar_url,
-              created_at: savedUser.created_at,
+        if (user && user.email) {
+          // 对于邮箱登录（Credentials Provider），user.id 就是 uuid
+          if (account?.provider === 'email') {
+            // 邮箱登录用户，直接从数据库获取用户信息
+            const emailUser = await findEmailUser(user.email);
+            if (emailUser) {
+              token.user = {
+                uuid: emailUser.uuid,
+                email: emailUser.email,
+                nickname: emailUser.nickname,
+                avatar_url: emailUser.avatar_url,
+                created_at: emailUser.created_at,
+              };
+            }
+          } else if (account) {
+            // OAuth登录用户，保存到数据库
+            const dbUser: User = {
+              uuid: getUuid(),
+              email: user.email,
+              nickname: user.name || "",
+              avatar_url: user.image || "",
+              signin_type: account.type,
+              signin_provider: account.provider,
+              signin_openid: account.providerAccountId,
+              created_at: getIsoTimestr(),
+              signin_ip: await getClientIp(),
             };
-          } catch (e) {
-            console.error("save user failed:", e);
+
+            try {
+              const savedUser = await saveUser(dbUser);
+
+              token.user = {
+                uuid: savedUser.uuid,
+                email: savedUser.email,
+                nickname: savedUser.nickname,
+                avatar_url: savedUser.avatar_url,
+                created_at: savedUser.created_at,
+              };
+            } catch (e) {
+              log.error("保存OAuth用户失败", e as Error, { email: user.email, provider: account?.provider });
+            }
           }
         }
         return token;
       } catch (e) {
-        console.error("jwt callback error:", e);
+        log.error("JWT回调异常", e as Error, { email: user?.email, provider: account?.provider });
         return token;
       }
     },
diff --git a/components/sign/form.tsx b/components/sign/form.tsx
index bc3dab8..ca68c37 100644
--- a/components/sign/form.tsx
+++ b/components/sign/form.tsx
@@ -1,5 +1,6 @@
 "use client";
 
+import { useState } from "react";
 import {
   Card,
   CardContent,
@@ -8,6 +9,7 @@ import {
   CardTitle,
 } from "@/components/ui/card";
 import { SiGithub, SiGoogle } from "react-icons/si";
+import { MdEmail } from "react-icons/md";
 
 import { Button } from "@/components/ui/button";
 import { Input } from "@/components/ui/input";
@@ -15,12 +17,34 @@ import { Label } from "@/components/ui/label";
 import { cn } from "@/lib/utils";
 import { signIn } from "next-auth/react";
 import { useTranslations } from "next-intl";
+import EmailLoginForm from "./email-login-form";
+import EmailRegisterForm from "./email-register-form";
 
 export default function SignForm({
   className,
   ...props
 }: React.ComponentPropsWithoutRef<"div">) {
   const t = useTranslations();
+  const [mode, setMode] = useState<'main' | 'email-login' | 'email-register'>('main');
+
+  if (mode === 'email-login') {
+    return (
+      <div className={cn("flex flex-col gap-6", className)} {...props}>
+        <EmailLoginForm
+          onBack={() => setMode('main')}
+          onRegister={() => setMode('email-register')}
+        />
+      </div>
+    );
+  }
+
+  if (mode === 'email-register') {
+    return (
+      <div className={cn("flex flex-col gap-6", className)} {...props}>
+        <EmailRegisterForm onBack={() => setMode('main')} />
+      </div>
+    );
+  }
 
   return (
     <div className={cn("flex flex-col gap-6", className)} {...props}>
@@ -36,6 +60,16 @@ export default function SignForm({
         <CardContent>
           <div className="grid gap-6">
             <div className="flex flex-col gap-4">
+              {/* 邮箱登录按钮 */}
+              <Button
+                variant="outline"
+                className="w-full"
+                onClick={() => setMode('email-login')}
+              >
+                <MdEmail className="w-4 h-4" />
+                {t("sign_modal.email_sign_in")}
+              </Button>
+
               {process.env.NEXT_PUBLIC_AUTH_GOOGLE_ENABLED === "true" && (
                 <Button
                   variant="outline"
diff --git a/components/sign/modal.tsx b/components/sign/modal.tsx
index c1f22c1..4ef7843 100644
--- a/components/sign/modal.tsx
+++ b/components/sign/modal.tsx
@@ -5,48 +5,35 @@ import * as React from "react";
 import {
   Dialog,
   DialogContent,
-  DialogDescription,
-  DialogHeader,
   DialogTitle,
-  DialogTrigger,
 } from "@/components/ui/dialog";
+import { VisuallyHidden } from "@radix-ui/react-visually-hidden";
 import {
   Drawer,
   DrawerClose,
   DrawerContent,
-  DrawerDescription,
   DrawerFooter,
-  DrawerHeader,
-  DrawerTitle,
-  DrawerTrigger,
 } from "@/components/ui/drawer";
-import { SiGithub, SiGmail, SiGoogle } from "react-icons/si";
 
 import { Button } from "@/components/ui/button";
-import { cn } from "@/lib/utils";
-import { signIn } from "next-auth/react";
 import { useAppContext } from "@/contexts/app";
 import { useMediaQuery } from "@/hooks/useMediaQuery";
 import { useTranslations } from "next-intl";
+import SignForm from "./form";
 
 export default function SignModal() {
   const t = useTranslations();
   const { showSignModal, setShowSignModal } = useAppContext();
-
-  const [open, setOpen] = React.useState(false);
   const isDesktop = useMediaQuery("(min-width: 768px)");
 
   if (isDesktop) {
     return (
       <Dialog open={showSignModal} onOpenChange={setShowSignModal}>
         <DialogContent className="sm:max-w-[425px]">
-          <DialogHeader>
+          <VisuallyHidden>
             <DialogTitle>{t("sign_modal.sign_in_title")}</DialogTitle>
-            <DialogDescription>
-              {t("sign_modal.sign_in_description")}
-            </DialogDescription>
-          </DialogHeader>
-          <ProfileForm />
+          </VisuallyHidden>
+          <SignForm />
         </DialogContent>
       </Dialog>
     );
@@ -55,13 +42,7 @@ export default function SignModal() {
   return (
     <Drawer open={showSignModal} onOpenChange={setShowSignModal}>
       <DrawerContent>
-        <DrawerHeader className="text-left">
-          <DrawerTitle>{t("sign_modal.sign_in_title")}</DrawerTitle>
-          <DrawerDescription>
-            {t("sign_modal.sign_in_description")}
-          </DrawerDescription>
-        </DrawerHeader>
-        <ProfileForm className="px-4" />
+        <SignForm className="px-4" />
         <DrawerFooter className="pt-4">
           <DrawerClose asChild>
             <Button variant="outline">{t("sign_modal.cancel_title")}</Button>
@@ -72,49 +53,4 @@ export default function SignModal() {
   );
 }
 
-function ProfileForm({ className }: React.ComponentProps<"form">) {
-  const t = useTranslations();
-
-  return (
-    <div className={cn("grid items-start gap-4", className)}>
-      {/* <div className="grid gap-2">
-        <Label htmlFor="email">{t("sign_modal.email_title")}</Label>
-        <Input type="email" id="email" placeholder="xxx@xxx.com" />
-      </div>
-      <div className="grid gap-2">
-        <Label htmlFor="password">{t("sign_modal.password_title")}</Label>
-        <Input id="password" type="password" />
-      </div>
-      <Button type="submit" className="w-full flex items-center gap-2">
-        <SiGmail className="w-4 h-4" />
-        {t("sign_modal.email_sign_in")}
-      </Button> */}
 
-      {process.env.NEXT_PUBLIC_AUTH_GOOGLE_ENABLED === "true" && (
-        <Button
-          variant="outline"
-          className="w-full flex items-center gap-2"
-          onClick={() => {
-            signIn("google");
-          }}
-        >
-          <SiGoogle className="w-4 h-4" />
-          {t("sign_modal.google_sign_in")}
-        </Button>
-      )}
-
-      {process.env.NEXT_PUBLIC_AUTH_GITHUB_ENABLED === "true" && (
-        <Button
-          variant="outline"
-          className="w-full flex items-center gap-2"
-          onClick={() => {
-            signIn("github");
-          }}
-        >
-          <SiGithub className="w-4 h-4" />
-          {t("sign_modal.github_sign_in")}
-        </Button>
-      )}
-    </div>
-  );
-}
diff --git a/contexts/app.tsx b/contexts/app.tsx
index 95cf56d..350f5e0 100644
--- a/contexts/app.tsx
+++ b/contexts/app.tsx
@@ -6,6 +6,8 @@ import {
   useContext,
   useEffect,
   useState,
+  useMemo,
+  useCallback,
 } from "react";
 import { cacheGet, cacheRemove } from "@/lib/cache";
 
@@ -36,11 +38,15 @@ export const AppContextProvider = ({ children }: { children: ReactNode }) => {
 
   const [showSignModal, setShowSignModal] = useState<boolean>(false);
   const [user, setUser] = useState<User | null>(null);
+  const [userLoading, setUserLoading] = useState<boolean>(false);
 
   const [showFeedback, setShowFeedback] = useState<boolean>(false);
 
-  const fetchUserInfo = async function () {
+  const fetchUserInfo = useCallback(async function () {
     try {
+      setUserLoading(true);
+      console.log("[fetchUserInfo] 开始获取用户信息");
+
       const resp = await fetch("/api/get-user-info", {
         method: "POST",
       });
@@ -55,18 +61,20 @@ export const AppContextProvider = ({ children }: { children: ReactNode }) => {
       }
 
       setUser(data);
+      console.log("[fetchUserInfo] 用户信息获取成功");
 
       updateInvite(data);
     } catch (e) {
-      console.log("fetch user info failed");
+      console.error("fetch user info failed", e);
+    } finally {
+      setUserLoading(false);
     }
-  };
+  }, []);
 
-  const updateInvite = async (user: User) => {
+  const updateInvite = useCallback(async (user: User) => {
     try {
       if (user.invited_by) {
         // user already been invited
-        console.log("user already been invited", user.invited_by);
         return;
       }
 
@@ -82,12 +90,10 @@ export const AppContextProvider = ({ children }: { children: ReactNode }) => {
 
       if (timeDiff <= 0 || timeDiff > 7200) {
         // user created more than 2 hours
-        console.log("user created more than 2 hours");
         return;
       }
 
       // update invite relation
-      console.log("update invite", inviteCode, user.uuid);
       const req = {
         invite_code: inviteCode,
         user_uuid: user.uuid,
@@ -110,29 +116,37 @@ export const AppContextProvider = ({ children }: { children: ReactNode }) => {
       setUser(data);
       cacheRemove(CacheKey.InviteCode);
     } catch (e) {
-      console.log("update invite failed: ", e);
+      console.error("update invite failed: ", e);
     }
-  };
+  }, []);
 
   useEffect(() => {
     if (session && session.user) {
       fetchUserInfo();
     }
-  }, [session]);
+  }, [session, fetchUserInfo]);
+
+  // 使用 useMemo 优化 context value
+  const contextValue = useMemo(() => ({
+    theme,
+    setTheme,
+    showSignModal,
+    setShowSignModal,
+    user,
+    setUser,
+    userLoading,
+    showFeedback,
+    setShowFeedback,
+  }), [
+    theme,
+    showSignModal,
+    user,
+    userLoading,
+    showFeedback,
+  ]);
 
   return (
-    <AppContext.Provider
-      value={{
-        theme,
-        setTheme,
-        showSignModal,
-        setShowSignModal,
-        user,
-        setUser,
-        showFeedback,
-        setShowFeedback,
-      }}
-    >
+    <AppContext.Provider value={contextValue}>
       {children}
     </AppContext.Provider>
   );
diff --git a/data/install.sql b/data/install.sql
index 970d2a3..032195c 100644
--- a/data/install.sql
+++ b/data/install.sql
@@ -14,9 +14,19 @@ CREATE TABLE users (
     updated_at timestamptz,
     invited_by VARCHAR(255) NOT NULL default '',
     is_affiliate BOOLEAN NOT NULL default false,
+    email_verified BOOLEAN DEFAULT FALSE,
+    email_verified_at timestamptz,
+    password_hash VARCHAR(255), -- 用于邮箱注册用户的密码
     UNIQUE (email, signin_provider)
 );
 
+-- 为 users 表添加重要索引
+CREATE INDEX idx_users_email ON users(email);
+CREATE INDEX idx_users_uuid ON users(uuid);
+CREATE INDEX idx_users_created_at ON users(created_at);
+CREATE INDEX idx_users_signin_provider ON users(signin_provider);
+CREATE INDEX idx_users_email_verified ON users(email_verified);
+
 CREATE TABLE orders (
     id SERIAL PRIMARY KEY,
     order_no VARCHAR(255) UNIQUE NOT NULL,
@@ -45,6 +55,13 @@ CREATE TABLE orders (
     paid_detail TEXT
 );
 
+-- 为 orders 表添加重要索引
+CREATE INDEX idx_orders_user_uuid ON orders(user_uuid);
+CREATE INDEX idx_orders_user_email ON orders(user_email);
+CREATE INDEX idx_orders_status ON orders(status);
+CREATE INDEX idx_orders_created_at ON orders(created_at);
+CREATE INDEX idx_orders_paid_at ON orders(paid_at);
+
 
 CREATE TABLE apikeys (
     id SERIAL PRIMARY KEY,
@@ -55,6 +72,10 @@ CREATE TABLE apikeys (
     status VARCHAR(50)
 );
 
+-- 为 apikeys 表添加索引
+CREATE INDEX idx_apikeys_user_uuid ON apikeys(user_uuid);
+CREATE INDEX idx_apikeys_status ON apikeys(status);
+
 CREATE TABLE credits (
     id SERIAL PRIMARY KEY,
     trans_no VARCHAR(255) UNIQUE NOT NULL,
@@ -66,6 +87,12 @@ CREATE TABLE credits (
     expired_at timestamptz
 );
 
+-- 为 credits 表添加索引
+CREATE INDEX idx_credits_user_uuid ON credits(user_uuid);
+CREATE INDEX idx_credits_trans_type ON credits(trans_type);
+CREATE INDEX idx_credits_created_at ON credits(created_at);
+CREATE INDEX idx_credits_expired_at ON credits(expired_at);
+
 CREATE TABLE posts (
     id SERIAL PRIMARY KEY,
     uuid VARCHAR(255) UNIQUE NOT NULL,
@@ -82,6 +109,12 @@ CREATE TABLE posts (
     locale VARCHAR(50)
 );
 
+-- 为 posts 表添加索引
+CREATE INDEX idx_posts_slug ON posts(slug);
+CREATE INDEX idx_posts_status ON posts(status);
+CREATE INDEX idx_posts_created_at ON posts(created_at);
+CREATE INDEX idx_posts_locale ON posts(locale);
+
 create table affiliates (
     id SERIAL PRIMARY KEY,
     user_uuid VARCHAR(255) NOT NULL,
@@ -94,6 +127,11 @@ create table affiliates (
     reward_amount INT NOT NULL default 0
 );
 
+-- 为 affiliates 表添加索引
+CREATE INDEX idx_affiliates_user_uuid ON affiliates(user_uuid);
+CREATE INDEX idx_affiliates_invited_by ON affiliates(invited_by);
+CREATE INDEX idx_affiliates_status ON affiliates(status);
+
 CREATE TABLE feedbacks (
     id SERIAL PRIMARY KEY,
     created_at timestamptz,
@@ -101,4 +139,30 @@ CREATE TABLE feedbacks (
     user_uuid VARCHAR(255),
     content TEXT,
     rating INT
-);
\ No newline at end of file
+);
+
+-- 为 feedbacks 表添加索引
+CREATE INDEX idx_feedbacks_user_uuid ON feedbacks(user_uuid);
+CREATE INDEX idx_feedbacks_status ON feedbacks(status);
+CREATE INDEX idx_feedbacks_created_at ON feedbacks(created_at);
+
+-- 邮箱验证码表
+CREATE TABLE email_verifications (
+    id SERIAL PRIMARY KEY,
+    email VARCHAR(255) NOT NULL,
+    code VARCHAR(10) NOT NULL,
+    type VARCHAR(50) NOT NULL, -- 'register', 'reset_password', 'change_email'
+    created_at timestamptz DEFAULT NOW(),
+    expires_at timestamptz NOT NULL,
+    verified_at timestamptz,
+    attempts INT DEFAULT 0,
+    max_attempts INT DEFAULT 5,
+    is_used BOOLEAN DEFAULT FALSE,
+    user_uuid VARCHAR(255)
+);
+
+-- 为 email_verifications 表添加索引
+CREATE INDEX idx_email_verifications_email_code ON email_verifications(email, code);
+CREATE INDEX idx_email_verifications_expires_at ON email_verifications(expires_at);
+CREATE INDEX idx_email_verifications_type ON email_verifications(type);
+CREATE INDEX idx_email_verifications_is_used ON email_verifications(is_used);
\ No newline at end of file
diff --git a/i18n/messages/en.json b/i18n/messages/en.json
index 686b96f..b63bcdd 100644
--- a/i18n/messages/en.json
+++ b/i18n/messages/en.json
@@ -27,6 +27,7 @@
     "continue": "Continue",
     "no_account": "Don't have an account?",
     "email_sign_in": "Sign in with Email",
+    "email_register": "Register with Email",
     "google_sign_in": "Sign in with Google",
     "github_sign_in": "Sign in with GitHub",
     "close_title": "Close",
diff --git a/i18n/messages/zh.json b/i18n/messages/zh.json
index 3e80684..6d33660 100644
--- a/i18n/messages/zh.json
+++ b/i18n/messages/zh.json
@@ -27,6 +27,7 @@
     "continue": "继续",
     "no_account": "还没有账户？",
     "email_sign_in": "使用邮箱登录",
+    "email_register": "邮箱注册",
     "google_sign_in": "使用 Google 登录",
     "github_sign_in": "使用 GitHub 登录",
     "close_title": "关闭",
diff --git a/lib/cache.ts b/lib/cache.ts
index 175d1a2..652a214 100644
--- a/lib/cache.ts
+++ b/lib/cache.ts
@@ -2,46 +2,81 @@ import { getTimestamp } from "./time";
 
 // get data from cache
 export const cacheGet = (key: string): string | null => {
-  let valueWithExpires = localStorage.getItem(key);
-  if (!valueWithExpires) {
+  // 检查是否在浏览器环境
+  if (typeof window === "undefined" || typeof localStorage === "undefined") {
     return null;
   }
 
-  let valueArr = valueWithExpires.split(":");
-  if (!valueArr || valueArr.length < 2) {
-    return null;
-  }
+  try {
+    let valueWithExpires = localStorage.getItem(key);
+    if (!valueWithExpires) {
+      return null;
+    }
 
-  const expiresAt = Number(valueArr[0]);
-  const currTimestamp = getTimestamp();
+    let valueArr = valueWithExpires.split(":");
+    if (!valueArr || valueArr.length < 2) {
+      return null;
+    }
 
-  if (expiresAt !== -1 && expiresAt < currTimestamp) {
-    // value expired
-    cacheRemove(key);
+    const expiresAt = Number(valueArr[0]);
+    const currTimestamp = getTimestamp();
 
-    return null;
-  }
+    if (expiresAt !== -1 && expiresAt < currTimestamp) {
+      // value expired
+      cacheRemove(key);
+      return null;
+    }
 
-  const searchStr = valueArr[0] + ":";
-  const value = valueWithExpires.replace(searchStr, "");
+    const searchStr = valueArr[0] + ":";
+    const value = valueWithExpires.replace(searchStr, "");
 
-  return value;
+    return value;
+  } catch (error) {
+    console.warn("Cache get error:", error);
+    return null;
+  }
 };
 
 // set data to cache
 // expiresAt: absolute timestamp, -1 means no expire
 export const cacheSet = (key: string, value: string, expiresAt: number) => {
-  const valueWithExpires = expiresAt + ":" + value;
+  // 检查是否在浏览器环境
+  if (typeof window === "undefined" || typeof localStorage === "undefined") {
+    return;
+  }
 
-  localStorage.setItem(key, valueWithExpires);
+  try {
+    const valueWithExpires = expiresAt + ":" + value;
+    localStorage.setItem(key, valueWithExpires);
+  } catch (error) {
+    console.warn("Cache set error:", error);
+  }
 };
 
 // remove data from cache
 export const cacheRemove = (key: string) => {
-  localStorage.removeItem(key);
+  // 检查是否在浏览器环境
+  if (typeof window === "undefined" || typeof localStorage === "undefined") {
+    return;
+  }
+
+  try {
+    localStorage.removeItem(key);
+  } catch (error) {
+    console.warn("Cache remove error:", error);
+  }
 };
 
 // clear all datas from cache
 export const cacheClear = () => {
-  localStorage.clear();
+  // 检查是否在浏览器环境
+  if (typeof window === "undefined" || typeof localStorage === "undefined") {
+    return;
+  }
+
+  try {
+    localStorage.clear();
+  } catch (error) {
+    console.warn("Cache clear error:", error);
+  }
 };
diff --git a/lib/resp.ts b/lib/resp.ts
index e5930a0..f465501 100644
--- a/lib/resp.ts
+++ b/lib/resp.ts
@@ -1,24 +1,79 @@
+// 统一的API响应类型
+export interface ApiResponse<T = any> {
+  code: number;
+  message: string;
+  data?: T;
+  timestamp?: string;
+}
+
+// 错误类型枚举
+export enum ErrorCode {
+  SUCCESS = 0,
+  GENERAL_ERROR = -1,
+  INVALID_PARAMS = 1001,
+  UNAUTHORIZED = 1002,
+  FORBIDDEN = 1003,
+  NOT_FOUND = 1004,
+  RATE_LIMITED = 1005,
+  DATABASE_ERROR = 2001,
+  EMAIL_ERROR = 2002,
+  PAYMENT_ERROR = 2003,
+  INTERNAL_ERROR = 5000,
+}
+
 export function respData(data: any) {
-  return respJson(0, "ok", data || []);
+  return respJson(ErrorCode.SUCCESS, "ok", data || []);
 }
 
 export function respOk() {
-  return respJson(0, "ok");
+  return respJson(ErrorCode.SUCCESS, "ok");
 }
 
-export function respErr(message: string) {
-  return respJson(-1, message);
+export function respErr(message: string, code: number = ErrorCode.GENERAL_ERROR) {
+  return respJson(code, message);
 }
 
 export function respJson(code: number, message: string, data?: any) {
-  let json = {
+  const json: ApiResponse = {
     code: code,
     message: message,
-    data: data,
+    timestamp: new Date().toISOString(),
   };
-  if (data) {
-    json["data"] = data;
+
+  if (data !== undefined) {
+    json.data = data;
   }
 
-  return Response.json(json);
+  // 根据错误码设置HTTP状态码
+  let status = 200;
+  if (code === ErrorCode.INVALID_PARAMS) status = 400;
+  else if (code === ErrorCode.UNAUTHORIZED) status = 401;
+  else if (code === ErrorCode.FORBIDDEN) status = 403;
+  else if (code === ErrorCode.NOT_FOUND) status = 404;
+  else if (code === ErrorCode.RATE_LIMITED) status = 429;
+  else if (code >= 2000) status = 500;
+  else if (code < 0) status = 500;
+
+  return Response.json(json, { status });
+}
+
+// 便捷的错误响应函数
+export function respInvalidParams(message: string = "参数无效") {
+  return respErr(message, ErrorCode.INVALID_PARAMS);
+}
+
+export function respUnauthorized(message: string = "未授权") {
+  return respErr(message, ErrorCode.UNAUTHORIZED);
+}
+
+export function respForbidden(message: string = "禁止访问") {
+  return respErr(message, ErrorCode.FORBIDDEN);
+}
+
+export function respNotFound(message: string = "资源不存在") {
+  return respErr(message, ErrorCode.NOT_FOUND);
+}
+
+export function respRateLimited(message: string = "请求过于频繁") {
+  return respErr(message, ErrorCode.RATE_LIMITED);
 }
diff --git a/models/credit.ts b/models/credit.ts
index 1cc2520..2a238a8 100644
--- a/models/credit.ts
+++ b/models/credit.ts
@@ -51,20 +51,64 @@ export async function findCreditByOrderNo(
 export async function getUserValidCredits(
   user_uuid: string
 ): Promise<Credit[] | undefined> {
-  const now = new Date().toISOString();
-  const supabase = getSupabaseClient();
-  const { data, error } = await supabase
-    .from("credits")
-    .select("*")
-    .eq("user_uuid", user_uuid)
-    .gte("expired_at", now)
-    .order("expired_at", { ascending: true });
+  const maxRetries = 3;
+  let lastError: any = null;
 
-  if (error) {
-    return undefined;
+  for (let attempt = 1; attempt <= maxRetries; attempt++) {
+    try {
+      console.log(`[getUserValidCredits] 开始查询用户积分 (尝试 ${attempt}/${maxRetries}), UUID:`, user_uuid);
+
+      const now = new Date().toISOString();
+      const supabase = getSupabaseClient();
+      const { data, error } = await supabase
+        .from("credits")
+        .select("*")
+        .eq("user_uuid", user_uuid)
+        .gte("expired_at", now)
+        .order("expired_at", { ascending: true });
+
+      if (error) {
+        console.error(`[getUserValidCredits] 数据库查询错误 (尝试 ${attempt}):`, {
+          code: error.code,
+          message: error.message,
+          user_uuid
+        });
+
+        // 如果是网络错误或超时错误且还有重试机会，继续重试
+        const isRetryableError = error.message.includes('fetch failed') ||
+                                error.message.includes('network') ||
+                                error.message.includes('TimeoutError') ||
+                                error.message.includes('timeout');
+
+        if (attempt < maxRetries && isRetryableError) {
+          lastError = error;
+          const retryDelay = attempt === 1 ? 500 : 1000;
+          console.log(`[getUserValidCredits] 网络/超时错误，${retryDelay}ms 后重试...`);
+          await new Promise(resolve => setTimeout(resolve, retryDelay));
+          continue;
+        }
+
+        return undefined;
+      }
+
+      console.log(`[getUserValidCredits] 查询成功 (尝试 ${attempt}), 积分记录数:`, data?.length || 0);
+      return data;
+    } catch (e) {
+      console.error(`[getUserValidCredits] 查询异常 (尝试 ${attempt}):`, e, "UUID:", user_uuid);
+      lastError = e;
+
+      // 如果还有重试机会，继续重试
+      if (attempt < maxRetries) {
+        const retryDelay = attempt === 1 ? 500 : 1000;
+        console.log(`[getUserValidCredits] 异常错误，${retryDelay}ms 后重试...`);
+        await new Promise(resolve => setTimeout(resolve, retryDelay));
+        continue;
+      }
+    }
   }
 
-  return data;
+  console.error(`[getUserValidCredits] 所有重试都失败了, UUID: ${user_uuid}, 最后错误:`, lastError);
+  return undefined;
 }
 
 export async function getCreditsByUserUuid(
diff --git a/models/db.ts b/models/db.ts
index df3ccd5..81f8c31 100644
--- a/models/db.ts
+++ b/models/db.ts
@@ -1,6 +1,14 @@
-import { createClient } from "@supabase/supabase-js";
+import { createClient, SupabaseClient } from "@supabase/supabase-js";
+
+// 全局客户端实例，避免重复创建
+let supabaseClient: SupabaseClient | null = null;
 
 export function getSupabaseClient() {
+  // 如果已有客户端实例，直接返回
+  if (supabaseClient) {
+    return supabaseClient;
+  }
+
   const supabaseUrl = process.env.SUPABASE_URL || "";
 
   let supabaseKey = process.env.SUPABASE_ANON_KEY || "";
@@ -12,7 +20,82 @@ export function getSupabaseClient() {
     throw new Error("Supabase URL or key is not set");
   }
 
-  const client = createClient(supabaseUrl, supabaseKey);
+  // 创建客户端实例并配置
+  supabaseClient = createClient(supabaseUrl, supabaseKey, {
+    auth: {
+      persistSession: false, // API 路由中不需要持久化会话
+    },
+    db: {
+      schema: 'public',
+    },
+    global: {
+      headers: {
+        'x-application-name': 'pc-t-app',
+        'Connection': 'keep-alive', // 保持连接
+      },
+      fetch: (url, options = {}) => {
+        return fetch(url, {
+          ...options,
+          // 增加到 10 秒超时，给数据库更多时间
+          signal: AbortSignal.timeout(10000),
+          // 添加连接管理
+          keepalive: true,
+        });
+      },
+    },
+  });
+
+  return supabaseClient;
+}
+
+/**
+ * 重置数据库连接（在连接问题时使用）
+ */
+export function resetSupabaseClient() {
+  console.log("[resetSupabaseClient] 重置数据库连接");
+  supabaseClient = null;
+  return getSupabaseClient();
+}
+
+/**
+ * 检查数据库连接健康状态
+ */
+export async function checkDatabaseHealth(): Promise<{ healthy: boolean; error?: string; latency?: number }> {
+  try {
+    const startTime = Date.now();
+    const supabase = getSupabaseClient();
+
+    // 执行一个简单的查询来测试连接，使用 count 而不是 select 减少数据传输
+    const { count, error } = await supabase
+      .from('users')
+      .select('*', { count: 'exact', head: true });
 
-  return client;
+    const latency = Date.now() - startTime;
+
+    if (error) {
+      console.error("[checkDatabaseHealth] 数据库连接检查失败:", {
+        code: error.code,
+        message: error.message,
+        details: error.details,
+        hint: error.hint
+      });
+      return {
+        healthy: false,
+        error: error.message,
+        latency
+      };
+    }
+
+    console.log(`[checkDatabaseHealth] 数据库连接正常, 延迟: ${latency}ms, 用户数: ${count}`);
+    return {
+      healthy: true,
+      latency
+    };
+  } catch (e) {
+    console.error("[checkDatabaseHealth] 数据库连接检查异常:", e);
+    return {
+      healthy: false,
+      error: e instanceof Error ? e.message : 'Unknown error'
+    };
+  }
 }
diff --git a/models/user.ts b/models/user.ts
index 8b2f02a..9b8be20 100644
--- a/models/user.ts
+++ b/models/user.ts
@@ -1,6 +1,7 @@
 import { User } from "@/types/user";
 import { getIsoTimestr } from "@/lib/time";
-import { getSupabaseClient } from "./db";
+import { getSupabaseClient, resetSupabaseClient } from "./db";
+import { log } from "@/lib/logger";
 
 export async function insertUser(user: User) {
   const supabase = getSupabaseClient();
@@ -16,34 +17,141 @@ export async function insertUser(user: User) {
 export async function findUserByEmail(
   email: string
 ): Promise<User | undefined> {
-  const supabase = getSupabaseClient();
-  const { data, error } = await supabase
-    .from("users")
-    .select("*")
-    .eq("email", email)
-    .limit(1)
-    .single();
-
-  if (error) {
+  // 验证邮箱格式
+  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
+  if (!emailRegex.test(email)) {
+    log.error("Invalid email format", undefined, { email });
     return undefined;
   }
 
-  return data;
+  const maxRetries = 3;
+  let lastError: any = null;
+
+  for (let attempt = 1; attempt <= maxRetries; attempt++) {
+    try {
+      log.debug(`开始查询用户 (尝试 ${attempt}/${maxRetries})`, { email, function: 'findUserByEmail' });
+
+      const supabase = getSupabaseClient();
+      const { data, error } = await supabase
+        .from("users")
+        .select("*")
+        .eq("email", email.toLowerCase().trim())
+        .limit(1)
+        .single();
+
+      if (error) {
+        // PGRST116 是 "not found" 错误，这是正常的，不需要重试
+        if (error.code === 'PGRST116') {
+          console.log(`[findUserByEmail] 用户不存在 (尝试 ${attempt}), Email:`, email);
+          return undefined;
+        }
+
+        console.error(`[findUserByEmail] 数据库查询错误 (尝试 ${attempt}):`, {
+          code: error.code,
+          message: error.message,
+          details: error.details,
+          hint: error.hint,
+          email
+        });
+
+        // 如果是网络错误或超时错误且还有重试机会，继续重试
+        const isRetryableError = error.message.includes('fetch failed') ||
+                                error.message.includes('network') ||
+                                error.message.includes('TimeoutError') ||
+                                error.message.includes('timeout');
+
+        if (attempt < maxRetries && isRetryableError) {
+          lastError = error;
+          const retryDelay = attempt === 1 ? 500 : 1000;
+          console.log(`[findUserByEmail] 网络/超时错误，${retryDelay}ms 后重试...`);
+          await new Promise(resolve => setTimeout(resolve, retryDelay));
+          continue;
+        }
+
+        // 其他错误直接返回 undefined
+        return undefined;
+      }
+
+      console.log(`[findUserByEmail] 查询成功 (尝试 ${attempt}), 找到用户:`, !!data);
+      return data;
+    } catch (e) {
+      console.error(`[findUserByEmail] 查询异常 (尝试 ${attempt}):`, e, "Email:", email);
+      lastError = e;
+
+      // 如果还有重试机会，继续重试
+      if (attempt < maxRetries) {
+        const retryDelay = attempt === 1 ? 500 : 1000;
+        console.log(`[findUserByEmail] 异常错误，${retryDelay}ms 后重试...`);
+        await new Promise(resolve => setTimeout(resolve, retryDelay));
+        continue;
+      }
+    }
+  }
+
+  console.error(`[findUserByEmail] 所有重试都失败了, Email: ${email}, 最后错误:`, lastError);
+  return undefined;
 }
 
 export async function findUserByUuid(uuid: string): Promise<User | undefined> {
-  const supabase = getSupabaseClient();
-  const { data, error } = await supabase
-    .from("users")
-    .select("*")
-    .eq("uuid", uuid)
-    .single();
+  const maxRetries = 3;
+  let lastError: any = null;
 
-  if (error) {
-    return undefined;
+  for (let attempt = 1; attempt <= maxRetries; attempt++) {
+    try {
+      console.log(`[findUserByUuid] 开始查询用户 (尝试 ${attempt}/${maxRetries}), UUID:`, uuid);
+
+      const supabase = getSupabaseClient();
+      const { data, error } = await supabase
+        .from("users")
+        .select("*")
+        .eq("uuid", uuid)
+        .single();
+
+      if (error) {
+        console.error(`[findUserByUuid] 数据库查询错误 (尝试 ${attempt}):`, {
+          code: error.code,
+          message: error.message,
+          details: error.details,
+          hint: error.hint,
+          uuid
+        });
+
+        // 如果是网络错误或超时错误且还有重试机会，继续重试
+        const isRetryableError = error.message.includes('fetch failed') ||
+                                error.message.includes('network') ||
+                                error.message.includes('TimeoutError') ||
+                                error.message.includes('timeout');
+
+        if (attempt < maxRetries && isRetryableError) {
+          lastError = error;
+          // 使用更短的重试间隔：500ms, 1000ms
+          const retryDelay = attempt === 1 ? 500 : 1000;
+          console.log(`[findUserByUuid] 网络/超时错误，${retryDelay}ms 后重试...`);
+          await new Promise(resolve => setTimeout(resolve, retryDelay));
+          continue;
+        }
+
+        return undefined;
+      }
+
+      console.log(`[findUserByUuid] 查询成功 (尝试 ${attempt}), 找到用户:`, !!data);
+      return data;
+    } catch (e) {
+      console.error(`[findUserByUuid] 查询异常 (尝试 ${attempt}):`, e, "UUID:", uuid);
+      lastError = e;
+
+      // 如果还有重试机会，继续重试
+      if (attempt < maxRetries) {
+        const retryDelay = attempt === 1 ? 500 : 1000;
+        console.log(`[findUserByUuid] 异常错误，${retryDelay}ms 后重试...`);
+        await new Promise(resolve => setTimeout(resolve, retryDelay));
+        continue;
+      }
+    }
   }
 
-  return data;
+  console.error(`[findUserByUuid] 所有重试都失败了, UUID: ${uuid}, 最后错误:`, lastError);
+  return undefined;
 }
 
 export async function getUsers(
@@ -145,3 +253,177 @@ export async function getUserUuidsByEmail(email: string) {
 
   return data.map((user) => user.uuid);
 }
+
+/**
+ * 创建邮箱注册用户
+ */
+export async function createEmailUser(user: User & { password_hash: string }) {
+  const supabase = getSupabaseClient();
+  const { data, error } = await supabase.from("users").insert({
+    ...user,
+    signin_type: 'email',
+    signin_provider: 'email',
+    // 保持传入的 email_verified 状态，不强制覆盖
+  });
+
+  if (error) {
+    throw error;
+  }
+
+  return data;
+}
+
+/**
+ * 验证用户邮箱
+ */
+export async function verifyUserEmail(email: string) {
+  // 验证邮箱格式
+  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
+  if (!emailRegex.test(email)) {
+    throw new Error("Invalid email format");
+  }
+
+  const supabase = getSupabaseClient();
+  const updated_at = getIsoTimestr();
+  const { data, error } = await supabase
+    .from("users")
+    .update({
+      email_verified: true,
+      email_verified_at: updated_at,
+      updated_at,
+    })
+    .eq("email", email.toLowerCase().trim())
+    .eq("signin_provider", "email");
+
+  if (error) {
+    throw error;
+  }
+
+  return data;
+}
+
+/**
+ * 根据邮箱查找邮箱注册用户
+ */
+export async function findEmailUser(email: string): Promise<User | undefined> {
+  // 验证邮箱格式
+  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
+  if (!emailRegex.test(email)) {
+    console.error("Invalid email format:", email);
+    return undefined;
+  }
+
+  const maxRetries = 3;
+  let lastError: any = null;
+
+  for (let attempt = 1; attempt <= maxRetries; attempt++) {
+    try {
+      console.log(`[findEmailUser] 开始查询邮箱用户 (尝试 ${attempt}/${maxRetries}), Email:`, email);
+
+      const supabase = getSupabaseClient();
+      const { data, error } = await supabase
+        .from("users")
+        .select("*")
+        .eq("email", email.toLowerCase().trim())
+        .eq("signin_provider", "email")
+        .limit(1)
+        .single();
+
+      if (error) {
+        // PGRST116 是 "not found" 错误，这是正常的，不需要重试
+        if (error.code === 'PGRST116') {
+          console.log(`[findEmailUser] 用户不存在 (尝试 ${attempt}), Email:`, email);
+          return undefined;
+        }
+
+        console.error(`[findEmailUser] 数据库查询错误 (尝试 ${attempt}):`, {
+          code: error.code,
+          message: error.message,
+          details: error.details,
+          hint: error.hint,
+          email
+        });
+
+        // 如果是网络错误或超时错误且还有重试机会，继续重试
+        const isRetryableError = error.message.includes('fetch failed') ||
+                                error.message.includes('network') ||
+                                error.message.includes('TimeoutError') ||
+                                error.message.includes('timeout');
+
+        if (attempt < maxRetries && isRetryableError) {
+          lastError = error;
+          // 使用指数退避：2s, 4s
+          const retryDelay = Math.pow(2, attempt) * 1000;
+          console.log(`[findEmailUser] 网络/超时错误，${retryDelay}ms 后重试...`);
+          await new Promise(resolve => setTimeout(resolve, retryDelay));
+          continue;
+        }
+
+        // 其他错误直接返回 undefined
+        return undefined;
+      }
+
+      console.log(`[findEmailUser] 查询成功 (尝试 ${attempt}), 找到用户:`, !!data);
+      return data;
+    } catch (e) {
+      console.error(`[findEmailUser] 查询异常 (尝试 ${attempt}):`, e, "Email:", email);
+      lastError = e;
+
+      // 如果还有重试机会，继续重试
+      if (attempt < maxRetries) {
+        const retryDelay = Math.pow(2, attempt) * 1000;
+        console.log(`[findEmailUser] 异常错误，${retryDelay}ms 后重试...`);
+
+        // 如果是第二次重试，重置数据库连接
+        if (attempt === 2) {
+          console.log("[findEmailUser] 重置数据库连接");
+          resetSupabaseClient();
+        }
+
+        await new Promise(resolve => setTimeout(resolve, retryDelay));
+        continue;
+      }
+    }
+  }
+
+  console.error(`[findEmailUser] 所有重试都失败了, Email: ${email}, 最后错误:`, lastError);
+  console.error(`[findEmailUser] 建议检查：
+    1. Supabase 数据库连接状态
+    2. 网络连接稳定性
+    3. 数据库连接池配置
+    4. 是否需要升级 Supabase 计划`);
+  return undefined;
+}
+
+/**
+ * 更新用户密码
+ */
+export async function updateUserPassword(email: string, password_hash: string) {
+  // 验证邮箱格式
+  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
+  if (!emailRegex.test(email)) {
+    throw new Error("Invalid email format");
+  }
+
+  // 验证密码哈希不为空
+  if (!password_hash || password_hash.trim().length === 0) {
+    throw new Error("Password hash cannot be empty");
+  }
+
+  const supabase = getSupabaseClient();
+  const updated_at = getIsoTimestr();
+  const { data, error } = await supabase
+    .from("users")
+    .update({
+      password_hash,
+      updated_at,
+    })
+    .eq("email", email.toLowerCase().trim())
+    .eq("signin_provider", "email");
+
+  if (error) {
+    throw error;
+  }
+
+  return data;
+}
diff --git a/next.config.mjs b/next.config.mjs
index 7fc1a4d..c50bbd4 100644
--- a/next.config.mjs
+++ b/next.config.mjs
@@ -28,6 +28,32 @@ const nextConfig = {
       },
     ],
   },
+  webpack: (config, { isServer }) => {
+    if (!isServer) {
+      // 在客户端构建中排除 Node.js 模块
+      config.resolve.fallback = {
+        ...config.resolve.fallback,
+        fs: false,
+        net: false,
+        tls: false,
+        dns: false,
+        os: false,
+        crypto: false,
+        stream: false,
+        util: false,
+        url: false,
+        querystring: false,
+        path: false,
+        child_process: false,
+        nodemailer: false,
+      };
+
+      // 排除 nodemailer 包
+      config.externals = config.externals || [];
+      config.externals.push('nodemailer');
+    }
+    return config;
+  },
   async redirects() {
     return [];
   },
diff --git a/package-lock.json b/package-lock.json
index 550b02b..b4479a3 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -41,10 +41,13 @@
         "@radix-ui/react-tooltip": "^1.1.6",
         "@stripe/stripe-js": "^5.4.0",
         "@supabase/supabase-js": "^2.47.10",
+        "@types/bcrypt": "^5.0.2",
         "@types/canvas-confetti": "^1.9.0",
         "@types/mdx": "^2.0.13",
         "@uiw/react-md-editor": "^4.0.5",
         "ai": "^4.1.64",
+        "axios": "^1.7.9",
+        "bcrypt": "^6.0.0",
         "canvas-confetti": "^1.9.3",
         "class-variance-authority": "^0.7.1",
         "clsx": "^2.1.1",
@@ -62,6 +65,7 @@
         "next-auth": "5.0.0-beta.25",
         "next-intl": "^4.0.2",
         "next-themes": "^0.4.4",
+        "nodemailer": "^6.9.18",
         "openai": "^4.78.1",
         "react": "^19.0.0",
         "react-copy-to-clipboard": "^5.1.0",
@@ -71,7 +75,7 @@
         "react-icons": "^5.4.0",
         "react-tweet": "^3.2.1",
         "simple-flakeid": "^0.0.5",
-        "sonner": "^1.7.1",
+        "sonner": "^1.7.4",
         "stripe": "^17.5.0",
         "tailwind-merge": "^2.6.0",
         "tailwindcss-animate": "^1.0.7",
@@ -84,6 +88,7 @@
         "@next/bundle-analyzer": "^15.1.3",
         "@types/markdown-it": "^14.1.2",
         "@types/node": "^20.17.10",
+        "@types/nodemailer": "^6.4.17",
         "@types/react": "^18.3.18",
         "@types/react-copy-to-clipboard": "^5.0.7",
         "@types/react-dom": "^18.3.5",
@@ -5071,6 +5076,15 @@
         "tslib": "^2.4.0"
       }
     },
+    "node_modules/@types/bcrypt": {
+      "version": "5.0.2",
+      "resolved": "https://registry.npmjs.org/@types/bcrypt/-/bcrypt-5.0.2.tgz",
+      "integrity": "sha512-6atioO8Y75fNcbmj0G7UjI9lXN2pQ/IGJ2FWT4a/btd0Lk9lQalHLKhkgKVZ3r+spnmWUKfbMi1GEe9wyHQfNQ==",
+      "license": "MIT",
+      "dependencies": {
+        "@types/node": "*"
+      }
+    },
     "node_modules/@types/canvas-confetti": {
       "version": "1.9.0",
       "resolved": "https://registry.npmjs.org/@types/canvas-confetti/-/canvas-confetti-1.9.0.tgz",
@@ -5210,6 +5224,16 @@
         "@types/node": "*"
       }
     },
+    "node_modules/@types/nodemailer": {
+      "version": "6.4.17",
+      "resolved": "https://registry.npmjs.org/@types/nodemailer/-/nodemailer-6.4.17.tgz",
+      "integrity": "sha512-I9CCaIp6DTldEg7vyUTZi8+9Vo0hi1/T8gv3C89yk1rSAAzoKQ8H8ki/jBYJSFoH/BisgLP8tkZMlQ91CIquww==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@types/node": "*"
+      }
+    },
     "node_modules/@types/phoenix": {
       "version": "1.6.6",
       "resolved": "https://registry.npmjs.org/@types/phoenix/-/phoenix-1.6.6.tgz",
@@ -7559,6 +7583,17 @@
         "node": ">=4"
       }
     },
+    "node_modules/axios": {
+      "version": "1.10.0",
+      "resolved": "https://registry.npmjs.org/axios/-/axios-1.10.0.tgz",
+      "integrity": "sha512-/1xYAC4MP/HEG+3duIhFr4ZQXR4sQXOIe+o6sdqzeykGLx6Upp/1p8MHqhINOvGeP7xyNHe7tsiJByc4SSVUxw==",
+      "license": "MIT",
+      "dependencies": {
+        "follow-redirects": "^1.15.6",
+        "form-data": "^4.0.0",
+        "proxy-from-env": "^1.1.0"
+      }
+    },
     "node_modules/axobject-query": {
       "version": "4.1.0",
       "resolved": "https://registry.npmjs.org/axobject-query/-/axobject-query-4.1.0.tgz",
@@ -7614,6 +7649,20 @@
         "url": "https://github.com/sponsors/wooorm"
       }
     },
+    "node_modules/bcrypt": {
+      "version": "6.0.0",
+      "resolved": "https://registry.npmjs.org/bcrypt/-/bcrypt-6.0.0.tgz",
+      "integrity": "sha512-cU8v/EGSrnH+HnxV2z0J7/blxH8gq7Xh2JFT6Aroax7UohdmiJJlxApMxtKfuI7z68NvvVcmR78k2LbT6efhRg==",
+      "hasInstallScript": true,
+      "license": "MIT",
+      "dependencies": {
+        "node-addon-api": "^8.3.0",
+        "node-gyp-build": "^4.8.4"
+      },
+      "engines": {
+        "node": ">= 18"
+      }
+    },
     "node_modules/binary-extensions": {
       "version": "2.3.0",
       "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
@@ -9854,6 +9903,26 @@
         "node": ">=8"
       }
     },
+    "node_modules/follow-redirects": {
+      "version": "1.15.9",
+      "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.9.tgz",
+      "integrity": "sha512-gew4GsXizNgdoRyqmyfMHyAmXsZDk6mHkSxZFCzW9gwlbtOW44CDtYavM+y+72qD/Vq2l550kMF52DT8fOLJqQ==",
+      "funding": [
+        {
+          "type": "individual",
+          "url": "https://github.com/sponsors/RubenVerborgh"
+        }
+      ],
+      "license": "MIT",
+      "engines": {
+        "node": ">=4.0"
+      },
+      "peerDependenciesMeta": {
+        "debug": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/for-each": {
       "version": "0.3.5",
       "resolved": "https://registry.npmjs.org/for-each/-/for-each-0.3.5.tgz",
@@ -13258,6 +13327,15 @@
         "node": "^10 || ^12 || >=14"
       }
     },
+    "node_modules/node-addon-api": {
+      "version": "8.4.0",
+      "resolved": "https://registry.npmjs.org/node-addon-api/-/node-addon-api-8.4.0.tgz",
+      "integrity": "sha512-D9DI/gXHvVmjHS08SVch0Em8G5S1P+QWtU31appcKT/8wFSPRcdHadIFSAntdMMVM5zz+/DL+bL/gz3UDppqtg==",
+      "license": "MIT",
+      "engines": {
+        "node": "^18 || ^20 || >= 21"
+      }
+    },
     "node_modules/node-domexception": {
       "version": "1.0.0",
       "resolved": "https://registry.npmjs.org/node-domexception/-/node-domexception-1.0.0.tgz",
@@ -13312,7 +13390,6 @@
       "version": "4.8.4",
       "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.4.tgz",
       "integrity": "sha512-LA4ZjwlnUblHVgq0oBF3Jl/6h/Nvs5fzBLwdEF4nuxnFdsfajde4WfxtJr3CaiH+F6ewcIB/q4jQ4UzPyid+CQ==",
-      "dev": true,
       "license": "MIT",
       "bin": {
         "node-gyp-build": "bin.js",
@@ -13320,6 +13397,15 @@
         "node-gyp-build-test": "build-test.js"
       }
     },
+    "node_modules/nodemailer": {
+      "version": "6.10.1",
+      "resolved": "https://registry.npmjs.org/nodemailer/-/nodemailer-6.10.1.tgz",
+      "integrity": "sha512-Z+iLaBGVaSjbIzQ4pX6XV41HrooLsQ10ZWPUehGmuantvzWoDVBnmsdUcOIDM1t+yPor5pDhVlDESgOMEGxhHA==",
+      "license": "MIT-0",
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
     "node_modules/nopt": {
       "version": "5.0.0",
       "resolved": "https://registry.npmjs.org/nopt/-/nopt-5.0.0.tgz",
@@ -14129,6 +14215,12 @@
         "url": "https://github.com/sponsors/wooorm"
       }
     },
+    "node_modules/proxy-from-env": {
+      "version": "1.1.0",
+      "resolved": "https://registry.npmjs.org/proxy-from-env/-/proxy-from-env-1.1.0.tgz",
+      "integrity": "sha512-D+zkORCbA9f1tdWRK0RaCR3GPv50cMxcrz4X8k5LTSUD1Dkw47mKJEZQNunItRTkWwgtaUSo1RVFRIG9ZXiFYg==",
+      "license": "MIT"
+    },
     "node_modules/pump": {
       "version": "3.0.2",
       "resolved": "https://registry.npmjs.org/pump/-/pump-3.0.2.tgz",
diff --git a/package.json b/package.json
index 1bf992e..af09d91 100644
--- a/package.json
+++ b/package.json
@@ -50,10 +50,13 @@
     "@radix-ui/react-tooltip": "^1.1.6",
     "@stripe/stripe-js": "^5.4.0",
     "@supabase/supabase-js": "^2.47.10",
+    "@types/bcrypt": "^5.0.2",
     "@types/canvas-confetti": "^1.9.0",
     "@types/mdx": "^2.0.13",
     "@uiw/react-md-editor": "^4.0.5",
     "ai": "^4.1.64",
+    "axios": "^1.7.9",
+    "bcrypt": "^6.0.0",
     "canvas-confetti": "^1.9.3",
     "class-variance-authority": "^0.7.1",
     "clsx": "^2.1.1",
@@ -71,6 +74,7 @@
     "next-auth": "5.0.0-beta.25",
     "next-intl": "^4.0.2",
     "next-themes": "^0.4.4",
+    "nodemailer": "^6.9.18",
     "openai": "^4.78.1",
     "react": "^19.0.0",
     "react-copy-to-clipboard": "^5.1.0",
@@ -80,7 +84,7 @@
     "react-icons": "^5.4.0",
     "react-tweet": "^3.2.1",
     "simple-flakeid": "^0.0.5",
-    "sonner": "^1.7.1",
+    "sonner": "^1.7.4",
     "stripe": "^17.5.0",
     "tailwind-merge": "^2.6.0",
     "tailwindcss-animate": "^1.0.7",
@@ -93,6 +97,7 @@
     "@next/bundle-analyzer": "^15.1.3",
     "@types/markdown-it": "^14.1.2",
     "@types/node": "^20.17.10",
+    "@types/nodemailer": "^6.4.17",
     "@types/react": "^18.3.18",
     "@types/react-copy-to-clipboard": "^5.0.7",
     "@types/react-dom": "^18.3.5",
diff --git a/pnpm-lock.yaml b/pnpm-lock.yaml
index af861b8..7ed0981 100644
--- a/pnpm-lock.yaml
+++ b/pnpm-lock.yaml
@@ -40,13 +40,13 @@ importers:
         version: 3.10.0(react-hook-form@7.54.2(react@19.0.0))
       '@mdx-js/loader':
         specifier: ^3.1.0
-        version: 3.1.0(acorn@8.14.0)
+        version: 3.1.0(acorn@8.14.1)
       '@mdx-js/react':
         specifier: ^3.1.0
         version: 3.1.0(@types/react@18.3.18)(react@19.0.0)
       '@next/mdx':
         specifier: ^15.1.3
-        version: 15.1.3(@mdx-js/loader@3.1.0(acorn@8.14.0))(@mdx-js/react@3.1.0(@types/react@18.3.18)(react@19.0.0))
+        version: 15.1.3(@mdx-js/loader@3.1.0(acorn@8.14.1))(@mdx-js/react@3.1.0(@types/react@18.3.18)(react@19.0.0))
       '@next/third-parties':
         specifier: ^15.1.2
         version: 15.1.2(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(react@19.0.0)
@@ -119,6 +119,9 @@ importers:
       ai:
         specifier: ^4.1.64
         version: 4.1.64(react@19.0.0)(zod@3.24.1)
+      axios:
+        specifier: ^1.7.9
+        version: 1.9.0
       canvas-confetti:
         specifier: ^1.9.3
         version: 1.9.3
@@ -163,13 +166,16 @@ importers:
         version: 15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
       next-auth:
         specifier: 5.0.0-beta.25
-        version: 5.0.0-beta.25(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(react@19.0.0)
+        version: 5.0.0-beta.25(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(nodemailer@6.10.1)(react@19.0.0)
       next-intl:
         specifier: ^4.0.2
         version: 4.0.2(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(react@19.0.0)(typescript@5.7.2)
       next-themes:
         specifier: ^0.4.4
         version: 0.4.4(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
+      nodemailer:
+        specifier: ^6.9.18
+        version: 6.10.1
       openai:
         specifier: ^4.78.1
         version: 4.78.1(zod@3.24.1)
@@ -231,6 +237,9 @@ importers:
       '@types/node':
         specifier: ^20.17.10
         version: 20.17.10
+      '@types/nodemailer':
+        specifier: ^6.4.17
+        version: 6.4.17
       '@types/react':
         specifier: ^18.3.18
         version: 18.3.18
@@ -1990,6 +1999,9 @@ packages:
   '@types/node@20.17.19':
     resolution: {integrity: sha512-LEwC7o1ifqg/6r2gn9Dns0f1rhK+fPFDoMiceTJ6kWmVk6bgXBI/9IOWfVan4WiAavK9pIVWdX0/e3J+eEUh5A==}
 
+  '@types/nodemailer@6.4.17':
+    resolution: {integrity: sha512-I9CCaIp6DTldEg7vyUTZi8+9Vo0hi1/T8gv3C89yk1rSAAzoKQ8H8ki/jBYJSFoH/BisgLP8tkZMlQ91CIquww==}
+
   '@types/phoenix@1.6.6':
     resolution: {integrity: sha512-PIzZZlEppgrpoT2QgbnDU+MMzuR6BbCjllj0bM70lWoejMeNJAxCchxnv7J3XFkI8MpygtRpzXrIlmWUBclP5A==}
 
@@ -2379,6 +2391,9 @@ packages:
     resolution: {integrity: sha512-Xm7bpRXnDSX2YE2YFfBk2FnF0ep6tmG7xPh8iHee8MIcrgq762Nkce856dYtJYLkuIoYZvGfTs/PbZhideTcEg==}
     engines: {node: '>=4'}
 
+  axios@1.9.0:
+    resolution: {integrity: sha512-re4CqKTJaURpzbLHtIi6XpDv20/CnpXOtjRY5/CU32L8gU8ek9UIivcfvSWvmKEngmVbrUtPpdDwWDWL7DNHvg==}
+
   axobject-query@4.1.0:
     resolution: {integrity: sha512-qIj0G9wZbMGNLjLmg1PT6v2mE9AH2zlnADJD/2tC6E00hgmhUOfEB6greHPAfLRSufHqROIUTkw6E+M3lH0PTQ==}
     engines: {node: '>= 0.4'}
@@ -3337,6 +3352,15 @@ packages:
   flatted@3.3.3:
     resolution: {integrity: sha512-GX+ysw4PBCz0PzosHDepZGANEuFCMLrnRTiEy9McGjmkCQYwRq4A/X786G/fjM/+OjsWSU1ZrY5qyARZmO/uwg==}
 
+  follow-redirects@1.15.9:
+    resolution: {integrity: sha512-gew4GsXizNgdoRyqmyfMHyAmXsZDk6mHkSxZFCzW9gwlbtOW44CDtYavM+y+72qD/Vq2l550kMF52DT8fOLJqQ==}
+    engines: {node: '>=4.0'}
+    peerDependencies:
+      debug: '*'
+    peerDependenciesMeta:
+      debug:
+        optional: true
+
   for-each@0.3.5:
     resolution: {integrity: sha512-dKx12eRCVIzqCxFGplyFKJMPvLEWgmNtUrpTiJIR5u97zEhRG8ySrtboPHZXx7daLxQVrl643cTzbab2tkQjxg==}
     engines: {node: '>= 0.4'}
@@ -4293,6 +4317,10 @@ packages:
     resolution: {integrity: sha512-LA4ZjwlnUblHVgq0oBF3Jl/6h/Nvs5fzBLwdEF4nuxnFdsfajde4WfxtJr3CaiH+F6ewcIB/q4jQ4UzPyid+CQ==}
     hasBin: true
 
+  nodemailer@6.10.1:
+    resolution: {integrity: sha512-Z+iLaBGVaSjbIzQ4pX6XV41HrooLsQ10ZWPUehGmuantvzWoDVBnmsdUcOIDM1t+yPor5pDhVlDESgOMEGxhHA==}
+    engines: {node: '>=6.0.0'}
+
   nopt@5.0.0:
     resolution: {integrity: sha512-Tbj67rffqceeLpcRXrT7vKAN8CwfPeIBgM7E6iBkmKLV7bEMwpGgYLGv0jACUsECaa/vuxP0IjEont6umdMgtQ==}
     engines: {node: '>=6'}
@@ -4582,6 +4610,9 @@ packages:
   property-information@7.0.0:
     resolution: {integrity: sha512-7D/qOz/+Y4X/rzSB6jKxKUsQnphO046ei8qxG59mtM3RG3DHgTK81HrxrmoDVINJb8NKT5ZsRbwHvQ6B68Iyhg==}
 
+  proxy-from-env@1.1.0:
+    resolution: {integrity: sha512-D+zkORCbA9f1tdWRK0RaCR3GPv50cMxcrz4X8k5LTSUD1Dkw47mKJEZQNunItRTkWwgtaUSo1RVFRIG9ZXiFYg==}
+
   pump@3.0.2:
     resolution: {integrity: sha512-tUPXtzlGM8FE3P0ZL6DVs/3P58k9nk8/jZeQCurTJylQA8qFYzHFfhBJkuqyE0FifOsQ0uKWekiZ5g8wtr28cw==}
 
@@ -5637,7 +5668,7 @@ snapshots:
 
   '@alloc/quick-lru@5.2.0': {}
 
-  '@auth/core@0.37.2':
+  '@auth/core@0.37.2(nodemailer@6.10.1)':
     dependencies:
       '@panva/hkdf': 1.2.1
       '@types/cookie': 0.6.0
@@ -5646,6 +5677,8 @@ snapshots:
       oauth4webapi: 3.3.1
       preact: 10.11.3
       preact-render-to-string: 5.2.3(preact@10.11.3)
+    optionalDependencies:
+      nodemailer: 6.10.1
 
   '@aws-crypto/crc32@5.2.0':
     dependencies:
@@ -6525,15 +6558,15 @@ snapshots:
       - encoding
       - supports-color
 
-  '@mdx-js/loader@3.1.0(acorn@8.14.0)':
+  '@mdx-js/loader@3.1.0(acorn@8.14.1)':
     dependencies:
-      '@mdx-js/mdx': 3.1.0(acorn@8.14.0)
+      '@mdx-js/mdx': 3.1.0(acorn@8.14.1)
       source-map: 0.7.4
     transitivePeerDependencies:
       - acorn
       - supports-color
 
-  '@mdx-js/mdx@3.1.0(acorn@8.14.0)':
+  '@mdx-js/mdx@3.1.0(acorn@8.14.1)':
     dependencies:
       '@types/estree': 1.0.6
       '@types/estree-jsx': 1.0.5
@@ -6547,7 +6580,7 @@ snapshots:
       hast-util-to-jsx-runtime: 2.3.2
       markdown-extensions: 2.0.0
       recma-build-jsx: 1.0.0
-      recma-jsx: 1.0.0(acorn@8.14.0)
+      recma-jsx: 1.0.0(acorn@8.14.1)
       recma-stringify: 1.0.0
       rehype-recma: 1.0.0
       remark-mdx: 3.1.0
@@ -6589,11 +6622,11 @@ snapshots:
     dependencies:
       fast-glob: 3.3.1
 
-  '@next/mdx@15.1.3(@mdx-js/loader@3.1.0(acorn@8.14.0))(@mdx-js/react@3.1.0(@types/react@18.3.18)(react@19.0.0))':
+  '@next/mdx@15.1.3(@mdx-js/loader@3.1.0(acorn@8.14.1))(@mdx-js/react@3.1.0(@types/react@18.3.18)(react@19.0.0))':
     dependencies:
       source-map: 0.7.4
     optionalDependencies:
-      '@mdx-js/loader': 3.1.0(acorn@8.14.0)
+      '@mdx-js/loader': 3.1.0(acorn@8.14.1)
       '@mdx-js/react': 3.1.0(@types/react@18.3.18)(react@19.0.0)
 
   '@next/swc-darwin-arm64@15.2.3':
@@ -7598,7 +7631,7 @@ snapshots:
 
   '@types/node-fetch@2.6.12':
     dependencies:
-      '@types/node': 20.17.10
+      '@types/node': 20.17.19
       form-data: 4.0.1
 
   '@types/node-forge@1.3.11':
@@ -7619,6 +7652,10 @@ snapshots:
     dependencies:
       undici-types: 6.19.8
 
+  '@types/nodemailer@6.4.17':
+    dependencies:
+      '@types/node': 20.17.19
+
   '@types/phoenix@1.6.6': {}
 
   '@types/prismjs@1.26.5': {}
@@ -7646,7 +7683,7 @@ snapshots:
 
   '@types/ws@8.5.13':
     dependencies:
-      '@types/node': 20.17.10
+      '@types/node': 20.17.19
 
   '@typescript-eslint/eslint-plugin@8.27.0(@typescript-eslint/parser@8.27.0(eslint@9.22.0(jiti@1.21.7))(typescript@5.7.2))(eslint@9.22.0(jiti@1.21.7))(typescript@5.7.2)':
     dependencies:
@@ -7954,10 +7991,6 @@ snapshots:
     dependencies:
       acorn: 8.14.0
 
-  acorn-jsx@5.3.2(acorn@8.14.0):
-    dependencies:
-      acorn: 8.14.0
-
   acorn-jsx@5.3.2(acorn@8.14.1):
     dependencies:
       acorn: 8.14.1
@@ -8140,6 +8173,14 @@ snapshots:
 
   axe-core@4.10.3: {}
 
+  axios@1.9.0:
+    dependencies:
+      follow-redirects: 1.15.9
+      form-data: 4.0.1
+      proxy-from-env: 1.1.0
+    transitivePeerDependencies:
+      - debug
+
   axobject-query@4.1.0: {}
 
   bail@2.0.2: {}
@@ -8615,7 +8656,7 @@ snapshots:
   esast-util-from-js@2.0.1:
     dependencies:
       '@types/estree-jsx': 1.0.5
-      acorn: 8.14.0
+      acorn: 8.14.1
       esast-util-from-estree: 2.0.0
       vfile-message: 4.0.2
 
@@ -9139,6 +9180,8 @@ snapshots:
 
   flatted@3.3.3: {}
 
+  follow-redirects@1.15.9: {}
+
   for-each@0.3.5:
     dependencies:
       is-callable: 1.2.7
@@ -10158,8 +10201,8 @@ snapshots:
 
   micromark-extension-mdxjs@3.0.0:
     dependencies:
-      acorn: 8.14.0
-      acorn-jsx: 5.3.2(acorn@8.14.0)
+      acorn: 8.14.1
+      acorn-jsx: 5.3.2(acorn@8.14.1)
       micromark-extension-mdx-expression: 3.0.0
       micromark-extension-mdx-jsx: 3.0.1
       micromark-extension-mdx-md: 2.0.0
@@ -10432,11 +10475,13 @@ snapshots:
 
   negotiator@1.0.0: {}
 
-  next-auth@5.0.0-beta.25(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(react@19.0.0):
+  next-auth@5.0.0-beta.25(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(nodemailer@6.10.1)(react@19.0.0):
     dependencies:
-      '@auth/core': 0.37.2
+      '@auth/core': 0.37.2(nodemailer@6.10.1)
       next: 15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0)
       react: 19.0.0
+    optionalDependencies:
+      nodemailer: 6.10.1
 
   next-intl@4.0.2(next@15.2.3(@opentelemetry/api@1.9.0)(react-dom@19.0.0(react@19.0.0))(react@19.0.0))(react@19.0.0)(typescript@5.7.2):
     dependencies:
@@ -10493,6 +10538,8 @@ snapshots:
 
   node-gyp-build@4.8.4: {}
 
+  nodemailer@6.10.1: {}
+
   nopt@5.0.0:
     dependencies:
       abbrev: 1.1.1
@@ -10777,6 +10824,8 @@ snapshots:
 
   property-information@7.0.0: {}
 
+  proxy-from-env@1.1.0: {}
+
   pump@3.0.2:
     dependencies:
       end-of-stream: 1.4.4
@@ -10903,9 +10952,9 @@ snapshots:
       estree-util-build-jsx: 3.0.1
       vfile: 6.0.3
 
-  recma-jsx@1.0.0(acorn@8.14.0):
+  recma-jsx@1.0.0(acorn@8.14.1):
     dependencies:
-      acorn-jsx: 5.3.2(acorn@8.14.0)
+      acorn-jsx: 5.3.2(acorn@8.14.1)
       estree-util-to-js: 2.0.0
       recma-parse: 1.0.0
       recma-stringify: 1.0.0
diff --git a/services/credit.ts b/services/credit.ts
index 9f22b4a..025ac5d 100644
--- a/services/credit.ts
+++ b/services/credit.ts
@@ -30,12 +30,17 @@ export async function getUserCredits(user_uuid: string): Promise<UserCredits> {
   };
 
   try {
+    console.log("[getUserCredits] 开始获取用户积分, UUID:", user_uuid);
+
     const first_paid_order = await getFirstPaidOrderByUserUuid(user_uuid);
     if (first_paid_order) {
       user_credits.is_recharged = true;
+      console.log("[getUserCredits] 用户已充值");
     }
 
     const credits = await getUserValidCredits(user_uuid);
+    console.log("[getUserCredits] 获取有效积分记录:", credits?.length || 0, "条");
+
     if (credits) {
       credits.forEach((v: Credit) => {
         user_credits.left_credits += v.credits;
@@ -50,9 +55,10 @@ export async function getUserCredits(user_uuid: string): Promise<UserCredits> {
       user_credits.is_pro = true;
     }
 
+    console.log("[getUserCredits] 积分计算完成:", user_credits);
     return user_credits;
   } catch (e) {
-    console.log("get user credits failed: ", e);
+    console.error("[getUserCredits] 获取用户积分失败, UUID:", user_uuid, "错误:", e);
     return user_credits;
   }
 }
diff --git a/services/order.ts b/services/order.ts
index a530bec..a8d242b 100644
--- a/services/order.ts
+++ b/services/order.ts
@@ -8,6 +8,8 @@ import { getIsoTimestr, getOneYearLaterTimestr } from "@/lib/time";
 
 import Stripe from "stripe";
 import { updateAffiliateForOrder } from "./affiliate";
+import { emailService } from "./email";
+import { findUserByUuid } from "@/models/user";
 
 export async function handleOrderSession(session: Stripe.Checkout.Session) {
   try {
@@ -41,6 +43,30 @@ export async function handleOrderSession(session: Stripe.Checkout.Session) {
 
       // update affiliate for paied order
       await updateAffiliateForOrder(order);
+
+      // 发送订单确认邮件（非阻塞）
+      const emailTo = paid_email || order.user_email || '';
+      if (emailTo) {
+        // 获取用户信息
+        const user = await findUserByUuid(order.user_uuid);
+
+        emailService.sendOrderConfirmationEmail(emailTo, {
+          orderNo: order.order_no,
+          amount: order.amount / 100, // 转换为元
+          credits: order.credits,
+          userName: user?.nickname || undefined,
+        })
+          .then((success) => {
+            if (success) {
+              console.log(`订单确认邮件发送成功: ${emailTo} - ${order_no}`);
+            } else {
+              console.log(`订单确认邮件发送失败: ${emailTo} - ${order_no}`);
+            }
+          })
+          .catch((error) => {
+            console.error(`订单确认邮件发送异常: ${emailTo} - ${order_no}`, error);
+          });
+      }
     }
 
     console.log(
diff --git a/services/user.ts b/services/user.ts
index 13373df..d1eb69f 100644
--- a/services/user.ts
+++ b/services/user.ts
@@ -7,11 +7,14 @@ import { getOneYearLaterTimestr } from "@/lib/time";
 import { getUserUuidByApiKey } from "@/models/apikey";
 import { headers } from "next/headers";
 import { increaseCredits } from "./credit";
+import { emailService } from "./email";
 
 export async function saveUser(user: User) {
   try {
     const existUser = await findUserByEmail(user.email);
-    if (!existUser) {
+    const isNewUser = !existUser;
+
+    if (isNewUser) {
       await insertUser(user);
 
       // increase credits for new user, expire in one year
@@ -21,6 +24,21 @@ export async function saveUser(user: User) {
         credits: CreditsAmount.NewUserGet,
         expired_at: getOneYearLaterTimestr(),
       });
+
+      // 发送欢迎邮件（非阻塞）
+      if (user.email && user.uuid) {
+        emailService.sendWelcomeEmail(user.email, user.nickname || undefined)
+          .then((success) => {
+            if (success) {
+              console.log(`欢迎邮件发送成功: ${user.email}`);
+            } else {
+              console.log(`欢迎邮件发送失败: ${user.email}`);
+            }
+          })
+          .catch((error) => {
+            console.error(`欢迎邮件发送异常: ${user.email}`, error);
+          });
+      }
     } else {
       user.id = existUser.id;
       user.uuid = existUser.uuid;
diff --git a/types/context.d.ts b/types/context.d.ts
index 5f8d251..a1af54d 100644
--- a/types/context.d.ts
+++ b/types/context.d.ts
@@ -1,5 +1,15 @@
 import { ReactNode } from "react";
+import { User } from "./user";
 
 export interface ContextValue {
+  theme: string;
+  setTheme: (theme: string) => void;
+  showSignModal: boolean;
+  setShowSignModal: (show: boolean) => void;
+  user: User | null;
+  setUser: (user: User | null) => void;
+  userLoading: boolean;
+  showFeedback: boolean;
+  setShowFeedback: (show: boolean) => void;
   [propName: string]: any;
 }
diff --git a/types/user.d.ts b/types/user.d.ts
index bb4eae4..a43e416 100644
--- a/types/user.d.ts
+++ b/types/user.d.ts
@@ -14,6 +14,9 @@ export interface User {
   invite_code?: string;
   invited_by?: string;
   is_affiliate?: boolean;
+  email_verified?: boolean;
+  email_verified_at?: string;
+  password_hash?: string;
 }
 
 export interface UserCredits {
